<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Social Messenger</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4; }
    .page { display: none; padding:20px; }
    .chat-box { height: 300px; overflow-y: scroll; border:1px solid #ccc; padding:10px; background:white; }
    .message { margin:5px 0; }
    .message b { color:#333; }
    .bottom-bar { display:flex; margin-top:5px; }
    .bottom-bar input { flex:1; padding:10px; }
    .bottom-bar button { padding:10px; background:blue; color:white; border:none; }
    button { margin-top:5px; }
  </style>
</head>
<body>

<!-- LOGIN / REGISTER -->
<div id="loginPage" class="page" style="display:block;">
  <h2 id="formTitle">Login</h2>
  <div id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email"><br>
    <input type="password" id="loginPassword" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </div>
  <div id="registerForm" style="display:none;">
    <input type="text" id="regName" placeholder="Full Name"><br>
    <input type="email" id="regEmail" placeholder="Email"><br>
    <input type="password" id="regPassword" placeholder="Password"><br>
    <button onclick="register()">Create Account</button>
  </div>
  <div style="margin-top:10px; cursor:pointer; color:blue;" onclick="toggleForm()">Create an account</div>
</div>

<!-- USER PANEL -->
<div id="userPanel" class="page">
  <h2>Welcome, <span id="userName"></span></h2>
  <button onclick="sendFriendRequest()">Send Friend Request to Admin</button>
  <button onclick="logout()">Logout</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="page">
  <h2>Admin Panel</h2>
  <div id="requestList"></div>
  <button onclick="logout()">Logout</button>
</div>

<!-- CHAT PAGE -->
<div id="chatPage" class="page">
  <h2>ðŸ“© Admin Group Chat</h2>
  <div id="chatBox" class="chat-box"></div>
  <div class="bottom-bar">
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
  </div>
  <button onclick="logout()">Logout</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBVPv24bcX6aLD3colMIP_tPkomhW1hotE",
    authDomain: "darpanbook.firebaseapp.com",
    databaseURL: "https://darpanbook-default-rtdb.firebaseio.com",
    projectId: "darpanbook",
    storageBucket: "darpanbook.appspot.com",
    messagingSenderId: "791059696742",
    appId: "1:791059696742:web:0bf51e375feaa0545a31a7"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentUser = null;
  const adminUID = "ADMIN_UID_HERE"; // Replace with actual admin UID
  const groupId = "adminGroup";

  function toggleForm() {
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const formTitle = document.getElementById("formTitle");
    if (loginForm.style.display === "none") {
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      formTitle.innerText = "Login";
    } else {
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      formTitle.innerText = "Create Account";
    }
  }

  function register() {
    const name = document.getElementById("regName").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value.trim();
    if (!name || !email || !password) return alert("Fill all fields");

    auth.createUserWithEmailAndPassword(email, password).then(userCred => {
      const uid = userCred.user.uid;
      let role = (email === "admin@example.com") ? "admin" : "user"; // Simple admin check
      return db.ref("users/" + uid).set({
        name, email, role
      });
    }).then(() => {
      alert("Account created! Please login.");
      toggleForm();
    }).catch(err => alert(err.message));
  }

  function login() {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    if (!email || !password) return alert("Fill all fields");

    auth.signInWithEmailAndPassword(email, password).then(userCred => {
      currentUser = userCred.user;
      return db.ref("users/" + currentUser.uid).once("value");
    }).then(snapshot => {
      const userData = snapshot.val();
      if (!userData) return alert("User not found!");
      showPanel(userData);
    }).catch(err => alert(err.message));
  }

  function showPanel(userData) {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    if (userData.role === "admin") {
      document.getElementById("adminPanel").style.display = "block";
      loadFriendRequests();
    } else {
      document.getElementById("userPanel").style.display = "block";
      document.getElementById("userName").innerText = userData.name;
    }
  }

  function sendFriendRequest() {
    db.ref(`friendRequests/${adminUID}/${currentUser.uid}`).set({
      from: currentUser.uid,
      status: "pending"
    }).then(() => {
      alert("Friend request sent to admin!");
    });
  }

  function loadFriendRequests() {
    db.ref(`friendRequests/${currentUser.uid}`).on("value", snap => {
      const list = document.getElementById("requestList");
      list.innerHTML = "";
      snap.forEach(reqSnap => {
        let req = reqSnap.val();
        let uid = req.from;
        let btn = `<button onclick="acceptRequest('${uid}')">Accept</button>`;
        list.innerHTML += `<div>${uid} ${btn}</div>`;
      });
    });
  }

  function acceptRequest(uid) {
    db.ref(`groups/${groupId}/members/${uid}`).set(true);
    db.ref(`friendRequests/${currentUser.uid}/${uid}`).remove();
    alert("User added to group!");
  }

  function joinGroupChat() {
    db.ref(`groups/${groupId}/members/${currentUser.uid}`).set(true);
    loadMessages();
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById("chatPage").style.display = "block";
  }

  function loadMessages() {
    db.ref(`groups/${groupId}/messages`).on("value", snap => {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      snap.forEach(msgSnap => {
        let m = msgSnap.val();
        chatBox.innerHTML += `<div class="message"><b>${m.senderName}:</b> ${m.text}</div>`;
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  function sendMessage() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text) return;
    db.ref(`users/${currentUser.uid}/name`).once("value").then(nameSnap => {
      const senderName = nameSnap.val();
      db.ref(`groups/${groupId}/messages`).push({
        senderName, text, timestamp: Date.now()
      });
      document.getElementById("messageInput").value = "";
    });
  }

  function logout() {
    auth.signOut().then(() => {
      currentUser = null;
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById("loginPage").style.display = "block";
    });
  }
</script>

</body>
</html>
